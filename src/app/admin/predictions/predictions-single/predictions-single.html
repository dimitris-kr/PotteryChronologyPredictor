<div class="inner">
    <div class="px-4 flex column gap-3">
        <div class="flex row wrap justify-between align-center">
            <h1 class="m-0">Predictions</h1>
            <button mat-icon-button routerLink="/admin/predictions" matTooltip="Back to All Predictions"
                    matTooltipPosition="above">
                <mat-icon>close_fullscreen</mat-icon>
            </button>
        </div>
        @if (prediction) {
            <div class="flex column gap-2">
                <h3 class="m-0">Prediction #{{ prediction.id }}</h3>
                <div class="meta flex row wrap gap-3">
                    <div>
                        Created: <strong>{{ prediction.created_at | date:'medium' }}</strong>
                    </div>
                </div>
            </div>
        }
    </div>

    @if (prediction) {
        <div class="flex row wrap justify-between align-stretch gy-4">
            <div class="w-5 flex align-stretch">
                <div class="card w-100 p-4 flex column justify-center">
                    <div class="badge primary card-title">
                        Predicted {{ isClassification(prediction) ? 'Historical Period' : 'Year Range' }}
                    </div>

                    @if (isClassification(prediction)) {
                        <div class="flex row nowrap justify-start align-center gap-2">
                            <div class="indicator"
                                 [ngStyle]="{'background-color': getColor(prediction.historical_period.name)}"></div>
                            <div class="display m-0">{{ prediction.historical_period.name }}</div>
                        </div>
                    } @else {
                        <div class="display m-0">{{ formatYear(prediction.start_year) }}
                            – {{ formatYear(prediction.end_year) }}
                        </div>
                    }
                </div>
            </div>
            <div class="w-7 w-100 flex align-stretch">
                <div class="card p-4 flex column justify-center input-data">
                    <div class="badge primary card-title">
                        Input Data
                    </div>
                    <div class="flex row wrap justify-between align-stretch gy-3">
                        <div class="w-7">
                            <h5>Description</h5>
                            <p>@if (prediction.input_text) {
                                {{ prediction.input_text }}
                            } @else {
                                -
                            }
                            </p>
                        </div>
                        <div class="w-5">
                            <h5>Image</h5>
                            @if (prediction.input_image_path) {
                                <div class="image-container">
                                    @if (imageUrl) {

                                        <img
                                            [src]="imageUrl"
                                            loading="lazy"
                                            alt="Pottery Image"
                                        >


                                    } @else {
                                        <mat-spinner diameter="25"></mat-spinner>
                                    }
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex column gap-4">

            <div class="px-4">
                <div class="flex row wrap justify-start align-center gap-2">
                    <h3>Feedback: True Chronology</h3>
                    <div class="badge" [ngClass]="getStatusClass(prediction)">
                        {{ prediction.status }}
                    </div>
                </div>

                @if (prediction.status === "validated" && prediction.pottery_item) {
                    <p>Feedback with the true chronology of the input data has been given for this prediction.</p>
                } @else {
                    <h6>Is this prediction correct?</h6>
                    <p>
                        Give feedback to the model, by submitting the true chronology for this input data. This helps
                        the model learn and make better predictions in the future.
                    </p>
                    <p>
                        After submitting true chronology this data will be inserted in the pottery dataset as a new
                        pottery item.
                    </p>
                }

            </div>

            @if (prediction.status === "validated" && prediction.pottery_item) {

                <div class="flex row wrap justify-between align-stretch gy-4">
                    @if (prediction.pottery_item.chronology_label) {
                        @if (isClassification(prediction)) {
                            <div class="w-5 flex align-stretch">
                                <div class="card w-100 p-4 flex column justify-center">
                                    <div class="badge primary card-title">
                                        True Historical Period
                                    </div>
                                    <div class="flex row nowrap justify-start align-center gap-2">
                                        <div class="indicator"
                                             [ngStyle]="{'background-color': getColor(prediction.pottery_item.chronology_label.historical_period.name)}"></div>
                                        <div
                                            class="display m-0">{{ prediction.pottery_item.chronology_label.historical_period.name }}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        } @else {
                            <div class="w-5 flex align-stretch">
                                <div class="card w-100 p-4 flex column justify-center">
                                    <div class="badge primary card-title">
                                        True Year Range
                                    </div>

                                    <div
                                        class="display m-0">{{ formatYear(prediction.pottery_item.chronology_label.start_year) }}
                                        – {{ formatYear(prediction.pottery_item.chronology_label.end_year) }}
                                    </div>
                                </div>
                            </div>
                        }
                        <div class="w-3 flex align-stretch">
                            <div class="card w-100 p-4 flex column justify-center">
                                <div class="badge primary card-title">
                                    Comparison
                                </div>
                                <div class="badge" [ngClass]="getMatchClass(prediction)"
                                     [matTooltip]="matchExplanation(prediction)" matTooltipPosition="above"
                                     style="font-size: 15px">
                                    {{ prediction.match === 'none' ? 'No' : prediction.match }} Match
                                </div>
                                <small>between predicted and true chronology</small>
                            </div>
                        </div>
                    }

                    <div class="w-4 flex align-stretch">
                        <div class="card w-100 p-4 flex column justify-center">
                            <div class="badge primary card-title">
                                Connected Pottery Item
                            </div>
                            <table class="vertical w-100">
                                <tr>
                                    <th colspan="2"><h5>Pottery Item #{{ prediction.pottery_item.id }}</h5></th>
                                </tr>
                                @if (prediction.pottery_item.chronology_label) {
                                <tr>
                                    <th>
                                        Chronology
                                    </th>
                                    <td>
                                        {{ formatYear(prediction.pottery_item.chronology_label.start_year) }}
                                        – {{ formatYear(prediction.pottery_item.chronology_label.end_year) }} <br>
                                        {{ prediction.pottery_item.chronology_label.historical_period.name }} Period
                                    </td>
                                </tr>
                                }
                                <tr>
                                    <th>Created</th>
                                    <td>
                                        {{prediction.pottery_item.created_at | date: 'medium'}}
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="2">
                                        <button mat-button [routerLink]="['/admin/data', prediction.pottery_item.id]">
                                            View Pottery Item
                                        </button>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>

            } @else {
            }

        </div>

        <div class="flex column gap-4">
            <div class="px-4">
                <h3 class="m-0">Prediction Breakdown</h3>
            </div>

            <div class="flex row wrap justify-between align-stretch gy-4">
                @if (prediction.breakdown) {
                    @if (isClassification(prediction)) {
                        <div class="w-7 flex align-stretch">
                            <div class="card p-4 w-100">
                                <div class="badge primary card-title">
                                    Predicted Period Probabilities
                                </div>
                                <div class="flex row wrap justify-center align-center gap-3">
                                    <app-classification-breakdown-chart [breakdown]="prediction.breakdown">
                                    </app-classification-breakdown-chart>

                                    <div class="legend-wrapper">
                                        <h6>Probability of Pottery Item belonging in each Period</h6>
                                        <table class="vertical legend w-100">
                                            @for (probability of sortedProbabilities; track probability.name;) {
                                                <tr>
                                                    <th>
                                                        <div class="flex row nowrap justify-start align-center gap-1">
                                                            <div class="indicator small"
                                                                 [ngStyle]="{'background-color': getColor(probability.name)}"></div>
                                                            <div>
                                                                {{ probability.name }}
                                                            </div>
                                                        </div>
                                                    </th>
                                                    <td>
                                                        {{ probability.value | percent:'1.2-2' }}
                                                    </td>
                                                </tr>
                                            }
                                        </table>
                                    </div>

                                </div>

                            </div>
                        </div>
                    } @else {
                        @if(prediction.breakdown.start_year) {

                        <div class="w-7 flex align-stretch">
                            <div class="card p-4 w-100 flex column gap-3">
                                <div class="badge primary card-title">
                                    Start Year Analysis
                                </div>
                                <app-regression-breakdown-chart
                                    [breakdown]="prediction.breakdown.start_year"
                                ></app-regression-breakdown-chart>

                                <table class="vertical w-100">
                                    <tr>
                                        <th>Model Uncertainty (STD)</th>
                                        <td>±{{ prediction.breakdown.start_year.std }} years </td>
                                    </tr>
                                    <tr>
                                        <th>95% Confidence Interval</th>
                                        <td>{{formatYear(prediction.breakdown.start_year.ci_lower)}} - {{formatYear(prediction.breakdown.start_year.ci_upper)}}</td>
                                    </tr>
                                    <tr>
                                        <th>Confidence Width</th>
                                        <td>{{Math.abs(prediction.breakdown.start_year.ci_upper - prediction.breakdown.start_year.ci_lower)}} years</td>
                                    </tr>
                                </table>

                            </div>
                        </div>
                        }

                        @if(prediction.breakdown.year_range) {

                            <div class="w-5 flex align-stretch">
                                <div class="card p-4 w-100 flex column gap-3">
                                    <div class="badge primary card-title">
                                        Year Range Analysis
                                    </div>
                                    <app-regression-breakdown-chart
                                        [breakdown]="prediction.breakdown.year_range"
                                    ></app-regression-breakdown-chart>

                                    <table class="vertical w-100">
                                        <tr>
                                            <th>Model Uncertainty (STD)</th>
                                            <td>±{{ prediction.breakdown.year_range.std }} years </td>
                                        </tr>
                                        <tr>
                                            <th>95% Confidence Interval</th>
                                            <td>{{prediction.breakdown.year_range.ci_lower}} - {{prediction.breakdown.year_range.ci_upper}} years</td>
                                        </tr>
                                        <tr>
                                            <th>Confidence Width</th>
                                            <td>{{Math.abs(prediction.breakdown.year_range.ci_upper - prediction.breakdown.year_range.ci_lower)}} years</td>
                                        </tr>
                                    </table>
                                </div>
                            </div>
                        }
                    }
                }

                <div class="w-5 flex align-stretch">
                    <div class="card p-4 w-100">
                        <div class="badge primary card-title">
                            Predictive Model Used
                        </div>

                        <table class="vertical w-100">
                            <tbody>
                            <tr>
                                <th>Name</th>
                                <td><span class="word-break-all">{{ prediction.model_version.model.name }}</span></td>
                            </tr>
                            <tr>
                                <th>Version</th>
                                <td>{{ prediction.model_version.version }}</td>
                            </tr>
                            <tr>
                                <th>Input</th>
                                <td>
                                    @for (ft of prediction.model_version.model.feature_sets; track ft.id; let idx = $index) {
                                        {{ ft.data_type }}
                                        @if (idx < prediction.model_version.model.feature_sets.length - 1) {
                                            &
                                        }
                                    }
                                </td>
                            </tr>
                            <tr>
                                <th>Output</th>
                                <td>
                                    @for (t of prediction.model_version.model.targets; track t.id; let idx = $index) {
                                        {{ t.name }}
                                        @if (idx < prediction.model_version.model.targets.length - 1) {
                                            &
                                        }
                                    }
                                </td>
                            </tr>
                                @if (prediction.model_version.val_accuracy) {
                                    <tr>
                                        <th>Accuracy</th>
                                        <td>{{ prediction.model_version.val_accuracy | percent:'1.0-2' }}</td>
                                    </tr>
                                } @else if (prediction.model_version.val_mae) {
                                    <tr>
                                        <th>Avg. Difference</th>
                                        <td>±{{ prediction.model_version.val_mae | number: '1.0-0' }} years</td>
                                    </tr>
                                }
                            <tr>
                                <th>Train Set</th>
                                <td>{{ prediction.model_version.train_sample_size }} samples</td>
                            </tr>
                            <tr>
                                <th>Trained</th>
                                <td>{{ prediction.model_version.created_at | date: 'medium' }}</td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>

        </div>
    }
</div>

